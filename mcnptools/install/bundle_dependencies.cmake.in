cmake_minimum_required(VERSION 3.12)

include(BundleUtilities)

IF(NOT "$ENV{DESTDIR}" STREQUAL "")
  SET(PREFIX "$ENV{DESTDIR}/${CMAKE_INSTALL_PREFIX}")
ELSE()
  SET(PREFIX "${CMAKE_INSTALL_PREFIX}")
ENDIF()

# Ensure bundle utilities is aware of lib directory.
FUNCTION(gp_resolved_file_type_override file type)
  GET_FILENAME_COMPONENT(LIBDIR "${file}" DIRECTORY)
  IF(LIBDIR STREQUAL "${PREFIX}/@CMAKE_INSTALL_LIBDIR@")
    SET(type "embedded" PARENT_SCOPE)
  ENDIF()
ENDFUNCTION()

FILE(MAKE_DIRECTORY "${PREFIX}/@CMAKE_INSTALL_SYSTEM_RUNTIME_DESTINATION@")
FILE(MAKE_DIRECTORY "${PREFIX}/@CMAKE_INSTALL_LIBDIR@")

FILE(GLOB BINDIRFILES "${PREFIX}/@CMAKE_INSTALL_BINDIR@/*")
FOREACH( BINDIRFILE ${BINDIRFILES} )
  MESSAGE(STATUS "Fixing up ${BINDIRFILE}" )
  fixup_bundle(
    "${BINDIRFILE}"
    ""
    "${PREFIX}/@CMAKE_INSTALL_SYSTEM_RUNTIME_DESTINATION@;${PREFIX}/@CMAKE_INSTALL_LIBDIR@")
ENDFOREACH( BINDIRFILE )

FILE(MAKE_DIRECTORY "${PREFIX}/@CMAKE_INSTALL_LIBDIR@")
SET(source "${PREFIX}/@CMAKE_INSTALL_BINDIR@")
SET(sink "${PREFIX}/@CMAKE_INSTALL_LIBDIR@")
FILE(GLOB shared_libraries RELATIVE "${source}" "${source}/*.so*")
FOREACH(shared_library IN LISTS shared_libraries)
  MESSAGE(STATUS "Copying ${shared_library} from ${source} to ${sink}")
  FILE(RENAME "${source}/${shared_library}" "${sink}/${shared_library}")
ENDFOREACH()

# Remove all `bin` files other than the one generated in the project.  That is,
# binaries generated by dependencies are removed.
# FILE(GLOB BINDIRFILES "${PREFIX}/@CMAKE_INSTALL_BINDIR@/*")
# LIST(REMOVE_ITEM BINDIRFILES "${PREFIX}/@CMAKE_INSTALL_BINDIR@/@PROJECT_NAME@")
# FILE(REMOVE ${BINDIRFILES})
