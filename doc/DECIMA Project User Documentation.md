# DECIMA Project User Documentation

**Author:** DECIMA Team

**Date:** 1er Sept 2025

## 1. Introduction to DECIMA

Welcome to DECIMA (Data Extraction & Contextual Inference for MCNP Analysis)! DECIMA is an intelligent tool designed to help you easily analyze and understand Particle Track (PTRAC) files generated by the MCNP nuclear simulation code. Whether you are an engineer, researcher, or student, DECIMA simplifies access to the complex information contained in your simulations.

Traditionally, analyzing PTRAC files requires in-depth knowledge of programming and the internal structure of these files. DECIMA changes the game by allowing you to ask questions in natural language (as you would to a colleague) and get precise answers, often accompanied by Python code that you can execute to validate or deepen the analysis.

**With DECIMA, you can:**

*   **Ask intuitive questions:** Describe what you want to know about your PTRAC file in French or English.
*   **Get clear explanations:** DECIMA provides you with detailed and understandable answers.
*   **Generate Python code:** For complex analyses, DECIMA automatically generates the necessary Python code, ready for execution.
*   **Visualize results:** Execute the generated code to see raw data or even graphs (if the code allows).

This user guide will walk you through how to get the most out of DECIMA, from preparing your environment to interpreting the results.




## 2. Quick Start

To start using DECIMA, follow these simple steps:

### 2.1. Accessing the Application

DECIMA is a web application. Once the system administrator has launched the application, you can access it via your web browser at the following address (default):

`http://127.0.0.1:5050`

You should see the main DECIMA interface, ready to receive your queries.

### 2.2. Loading a PTRAC File

Before asking questions, you must load the PTRAC file you want to analyze. This is a crucial step because DECIMA will perform all its analyses on this file.

1.  **Click the "Load PTRAC File" button** (or "Charger Fichier PTRAC" if the interface is localized in French). This button is usually located at the top of the page.
2.  A file selection window will open. **Navigate to the location of your PTRAC file** on your computer and select it.
3.  Once the file is selected, its name should appear next to the button, confirming that it has been successfully loaded into the application. If an error message appears, check your file format or try again.

**Important:** DECIMA can only analyze one PTRAC file at a time. If you load a new file, it will replace the previous one.

### 2.3. Asking a Question

Now that your PTRAC file is loaded, you can query DECIMA.

1.  **Enter your question** in the text area at the bottom of the chat interface. Be as precise and concise as possible. DECIMA is designed to understand natural language, but a well-formulated question will yield better results.
    *   **Examples of questions:**
        *   "Display x, y, z position and energy of neutrons crossing surface 12."
        *   "How many secondary photons are emitted by inelastic scattering?"
        *   "What is the energy distribution of generated (n,xn) fission neutrons?"
2.  **Check or uncheck the "Add context" box:**
    *   **Checked (default and recommended):** DECIMA will use its Knowledge Graph to enrich its understanding of your question. This is recommended for most queries, as it helps DECIMA be more precise.
    *   **Unchecked:** DECIMA will respond without using its Knowledge Graph context. This can be useful for very generic questions or if you encounter issues with context addition.
3.  **Click the "Send" button** (the paper airplane icon) to the right of the text area.

DECIMA will then process your query. A "Reasoning..." message will appear while the system analyzes your question and generates a response.

### 2.4. Interpreting DECIMA's Response

Once processing is complete, DECIMA will display its response in the chat area. The response usually consists of two parts:

1.  **Natural language explanation:** A clear and pedagogical description of the answer to your question, explaining concepts and results.
2.  **Python code block:** For questions requiring data analysis, DECIMA will generate a Python script using the `mcnptools` library. This code is the translation of your question into programming instructions.

### 2.5. Executing the Python Code

The Python code generated by DECIMA is not executed automatically. You have the option to do so manually to see the concrete results.

1.  **Click the "Execute code" button** located below the Python code block.
2.  DECIMA will execute the code in a secure environment (sandbox) using the PTRAC file you loaded.
3.  The execution results will appear in the "Execution Result" section at the bottom of the page:
    *   **Stdout:** The standard output of the script (e.g., numerical values, `print` messages).
    *   **Stderr:** Error messages or warnings generated during code execution.
    *   **Image:** If the code generates a graph (e.g., an energy distribution), the image will be displayed here.

**Interrupting execution:** If a script takes too long or appears stuck, a "Stop Code Generation" button will appear. Click it to stop the execution.




## 3. Advanced Usage

### 3.1. Formulating Effective Questions

To get the best results from DECIMA, it is helpful to understand how to formulate your questions. Think about how you would describe your problem to a human expert who knows `mcnptools` and PTRAC files.

*   **Be precise:** Instead of "Give me information about neutrons," ask "What is the average energy of neutrons crossing surface 300?"
*   **Use MCNP/PTRAC vocabulary:** Mention terms like "event," "history," "particle," "cell," "surface," "energy," "weight," "time," "ZAID," "reaction," "bank," etc.
*   **Specify conditions:** If you are looking for data for a specific particle, cell, or surface, include its identifier (e.g., "neutrons," "cell 200," "surface 300").
*   **Indicate the desired result type:** "Display," "Calculate," "Plot," "Give the number of," "What is the average of," "List the...", etc.
*   **Complex questions:** DECIMA can handle multi-criteria questions. For example: "Display the x, y, z position and energy of the first 5 electrons in the first history that have an energy greater than 1 MeV and are generated by a photo-electron bank event."

### 3.2. Understanding LLM Context

The "Add context" checkbox controls whether DECIMA uses its Knowledge Graph (KG) to enrich its understanding of your question. Here's when and why you might want to change it:

*   **Context enabled (default and recommended):** When this option is checked, DECIMA queries its KG to find relevant information about `mcnptools` classes, enumerations, dictionaries (like MT reaction types or particle codes), and their relationships. This helps the LLM (OTACON) generate more precise code and avoid errors, as it has structured knowledge of PTRAC tools and data.
    *   **Advantage:** More relevant responses and more reliable code for complex or specific questions.
    *   **Disadvantage:** Can sometimes introduce irrelevant entities if your question is ambiguous, or slightly slow down processing.

*   **Context disabled:** If you uncheck this option, DECIMA will rely solely on the general knowledge of its language model and the code examples it has learned. It will not query the KG.
    *   **Advantage:** Can be faster for very simple questions or if you feel that the KG context is "interfering" with the LLM's response for some reason.
    *   **Disadvantage:** The LLM may be less precise or generate incorrect code if it lacks specific information about `mcnptools` or PTRAC conventions.

In general, it is advisable to leave the context enabled, unless you encounter specific problems or wish to experiment.

### 3.3. Analyzing Execution Results

After executing the generated code, the "Execution Result" section provides crucial information:

*   **`stdout` (Standard Output):** This is where the Python script displays its results. If the code is designed to print values, lists, or messages, they will appear here. This is the "normal" output of the program.
*   **`stderr` (Standard Error):** This section displays error messages or warnings generated by the Python script. If your code does not run as expected, or if a programming error occurs, the details of the error will be here. Read these messages carefully to understand what went wrong.
*   **Image:** If the generated Python code includes instructions to create graphs (e.g., with `matplotlib`), the resulting image will be displayed in this section. This allows you to directly visualize distributions, trends, or other graphical representations of your PTRAC data.

**Debugging tips:**
*   If `stderr` contains errors, read the last line to identify the type of error and the affected line of code. This will help you understand if the problem comes from the generated code or your PTRAC data.
*   If `stdout` is empty when you expected output, check that the Python code contains `print()` statements to display the results.
*   If the image does not appear, make sure that the generated code includes plotting commands and that `allow_plots` is enabled during execution (which is the case via the web interface).




## 4. Troubleshooting and Frequently Asked Questions

This section addresses common issues you might encounter when using DECIMA and provides solutions.

### 4.1. PTRAC File Loading Issues

*   **"No file provided." or "Empty file name."**
    *   **Cause:** You have not selected a file or the selected file does not have a valid name.
    *   **Solution:** Make sure you select a file through the file dialog. Check that the file name does not contain special characters that could cause problems.
*   **"Save error."**
    *   **Cause:** The system could not save the PTRAC file to the temporary `uploads` folder.
    *   **Solution:** Contact the system administrator. This could be a permissions issue or disk space problem.
*   **The file is loaded, but analyses do not work.**
    *   **Cause:** The PTRAC file is corrupted or not in a format recognized by `mcnptools`.
    *   **Solution:** Verify the integrity of your PTRAC file with MCNP or another tool. Make sure it is a valid PTRAC file (binary or ASCII).

### 4.2. LLM (OTACON) Response Issues

*   **The response is generic or does not contain code.**
    *   **Cause:** The question is too vague, or the LLM did not understand the intention to generate code.
    *   **Solution:** Rephrase your question to be more precise. Use action verbs like "Display," "Calculate," "Generate code for," "Plot the distribution of." Make sure your question is directly related to PTRAC data analysis.
*   **The generated code is incorrect or does not match the question.**
    *   **Cause:** The LLM misinterpreted your query, or the context provided by EMMA was insufficient/erroneous.
    *   **Solution:**
        *   **Check the "Add context" box:** If it is unchecked, try checking it. If it is already checked, try unchecking it to see if that improves the situation (rare, but possible).
        *   **Rephrase the question:** Try using synonyms or simplifying the question. Avoid ambiguities.
        *   **Check technical terms:** Make sure the MCNP/PTRAC terms you are using are correct and common.
*   **"Reasoning..." remains displayed for a long time.**
    *   **Cause:** The LLM is taking a long time to generate the response, or there is a connection issue with the OpenAI API.
    *   **Solution:** Wait a few moments. If the problem persists, check your internet connection. If you are the administrator, check the Flask server logs and the OpenAI API key configuration.

### 4.3. Code Execution (EVA) Issues

*   **"No PTRAC file loaded." (in `stderr` after execution).**
    *   **Cause:** You attempted to execute code without first loading a PTRAC file.
    *   **Solution:** Load a PTRAC file by following the steps in section 2.2.
*   **"Timeout: execution too long." (in `stderr`).**
    *   **Cause:** The generated code entered an infinite loop, is too complex, or the PTRAC file is very large and the analysis is taking too long.
    *   **Solution:**
        *   **Interrupt execution:** Use the "Stop Code Generation" button if available.
        *   **Simplify the query:** Request an analysis on a subset of data (e.g., "the first 10 histories" instead of "all histories").
        *   **Check the code:** If you have Python knowledge, examine the generated code to identify potential loops or costly operations.
*   **Python errors in `stderr` (e.g., `NameError`, `AttributeError`, `IndexError`).**
    *   **Cause:** The generated code contains syntax errors, uses non-existent functions or attributes, or attempts to access data not present in the PTRAC file.
    *   **Solution:**
        *   **Read the error message:** It indicates the line and type of error. This can give you clues about the cause.
        *   **Rephrase the question:** If the error seems related to a misunderstanding by the LLM, try asking the question differently.
        *   **Check the PTRAC file:** Make sure the data you are requesting actually exists in your PTRAC file (e.g., if you ask for electrons, make sure your simulation produced them).
*   **The plot image does not display.**
    *   **Cause:** The generated code does not contain plotting instructions, or there was an error during graph generation.
    *   **Solution:** Make sure your question implies a visualization (e.g., "plot the distribution," "display a histogram"). Check `stderr` for any plotting-related errors.

### 4.4. General Questions

*   **Can I use DECIMA with any MCNP file?**
    *   DECIMA is specifically designed to analyze **PTRAC** files generated by MCNP. It cannot directly analyze MCNP input files (`.inp`) or full output files (`.out`), unless they contain PTRAC data.
*   **Is my data secure?**
    *   The PTRAC files you upload are processed locally on the server where DECIMA is deployed. The code generated by the LLM is executed in a sandboxed environment for security reasons. However, the confidentiality of your data depends on the configuration and security of the server on which DECIMA is hosted. For very sensitive data, consult your system administrator.
*   **Can I modify the generated Python code?**
    *   Yes, you can copy the generated code and modify it in your own Python environment if you wish. DECIMA is an assistant, but you retain full control over the final analysis.



